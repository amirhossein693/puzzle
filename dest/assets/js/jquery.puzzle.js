!function(a){"use strict";a.fn.puzzle=function(b,c,d){var e=this,f=new Image;f.src=d;var g=document.getElementById(e.attr("id")).width,h={getSolvedTime:function(){return j.solved?j.solvedTime:"Not Solved"}},i=a.extend({tileCount:3,time:3,timeWrapper:!1,lostFlag:!1,timeLabel:["<label>Countdown Time</label>","x","seconds"],timeFormat:"minutes",solvedMsg:"You solved it !",solvedMaskMsg:["Solved in","x","seconds"],solvedCallback:!1,lostMsg:"Time is over"},b,c),j={solved:!1,clockInterval:"",solvedTime:"Not Solved",countdownFlag:!1,boardParts:"",tileSize:g/i.tileCount,solvedMaskFlag:!1,emptyLoc:{x:0,y:0},clickLoc:{x:0,y:0},context:document.getElementById(e.attr("id")).getContext("2d"),imageLoader:function(b){function c(){clearTimeout(j),i>h?(f.off("error").off("load"),f=e().attr("src",b).hide(),h++):g.reject()}function d(){clearTimeout(j),a("body").append(f),g.resolve(f)}function e(){return j=setTimeout(c,8e3),f=a("<img/>").load(d).error(c)}if(a.isArray(b))return a.when.apply(a,a.map(b,function(a){return imageLoader(a)}));var f,g=a.Deferred(),h=0,i=5,j=0;return e().attr("src",b).hide(),g.promise()},setBoard:function(){j.boardParts=new Array(i.tileCount);for(var a=0;a<i.tileCount;++a){j.boardParts[a]=new Array(i.tileCount);for(var b=0;b<i.tileCount;++b)j.boardParts[a][b]={},j.boardParts[a][b].x=i.tileCount-1-a,j.boardParts[a][b].y=i.tileCount-1-b}j.emptyLoc.x=j.boardParts[i.tileCount-1][i.tileCount-1].x,j.emptyLoc.y=j.boardParts[i.tileCount-1][i.tileCount-1].y,j.solved=!1},drawTiles:function(){j.context.clearRect(0,0,g,g);for(var a=0;a<i.tileCount;++a)for(var b=0;b<i.tileCount;++b){var c=j.boardParts[a][b].x,d=j.boardParts[a][b].y;(a!=j.emptyLoc.x||b!=j.emptyLoc.y||j.solved===!0)&&j.context.drawImage(f,c*j.tileSize,d*j.tileSize,j.tileSize,j.tileSize,a*j.tileSize,b*j.tileSize,j.tileSize,j.tileSize)}},distance:function(a,b,c,d){return Math.abs(a-c)+Math.abs(b-d)},slideTile:function(a,b){j.solved||(j.boardParts[a.x][a.y].x=j.boardParts[b.x][b.y].x,j.boardParts[a.x][a.y].y=j.boardParts[b.x][b.y].y,j.boardParts[b.x][b.y].x=i.tileCount-1,j.boardParts[b.x][b.y].y=i.tileCount-1,a.x=b.x,a.y=b.y,j.checkSolved())},checkSolved:function(){for(var a=!0,b=0;b<i.tileCount;++b)for(var c=0;c<i.tileCount;++c)(j.boardParts[b][c].x!=b||j.boardParts[b][c].y!=c)&&(a=!1);j.solved=a,j.countdownFlag=a},setFormat:function(a){var b={};return"seconds"===i.timeFormat?a:(b.minutes=Math.floor(a/60),b.seconds=a-60*b.minutes,b.minutes+" : "+b.seconds)},countdown:function(){function b(a){return 0!==a||j.lostFlag||(j.lostFlag=!0,j.lostMask()),a>0&&!j.countdownFlag?(d=a-1,j.solvedTime=60*i.time-d,j.setFormat(d)):void 0}var c={},d=60*i.time;i.timeWrapper!==!1?c.mainWrapper=a(i.timeWrapper):(0===a("#puzzle-countdown-wrapper").length&&e.parent().prepend('<div id="puzzle-countdown-wrapper">'+j.getClockMask('<time dir="ltr" id="puzzle-countdown">'+j.setFormat(d)+"</time> ")+"</div>"),c.mainWrapper=a("#puzzle-countdown")),j.clockInterval=setInterval(function(){c.mainWrapper.html(b(d))},1e3)},getClockMask:function(b){return a.map(i.timeLabel,function(a,c){"x"==a&&(i.timeLabel[c]=b)}),i.timeLabel.join(" ")},getSolvedMsg:function(){return a.map(i.solvedMaskMsg,function(a,b){"x"==a&&(i.solvedMaskMsg[b]=j.solvedTime)}),i.solvedMaskMsg.join(" ")},solvedMask:function(){j.solvedMaskFlag||(j.context.fillStyle="rgba(255,255,255, 0.5)",j.context.fillRect(0,0,g,g),j.context.fillStyle="rgba(0,0,0, 1)",j.context.font="30px Arial",j.context.fillText(j.getSolvedMsg(),g/4,g/2),j.solvedMaskFlag=!0,a(e).off("click"))},lostMask:function(){j.lostFlag&&(j.context.fillStyle="rgba(255,255,255, 0.5)",j.context.fillRect(0,0,g,g),j.context.fillStyle="rgba(0,0,0, 1)",j.context.font="30px Arial",j.context.fillText(i.lostMsg,g/4,g/2),j.solvedMaskFlag=!0,a(e).off("click"))},play:function(){j.solvedMaskFlag||a(e).on("click",function(a){j.clickLoc.x=Math.floor((a.pageX-this.offsetLeft)/j.tileSize),j.clickLoc.y=Math.floor((a.pageY-this.offsetTop)/j.tileSize),1==j.distance(j.clickLoc.x,j.clickLoc.y,j.emptyLoc.x,j.emptyLoc.y)&&(j.slideTile(j.emptyLoc,j.clickLoc),j.drawTiles()),j.solved&&(i.solvedCallback!==!1?i.solvedCallback():setTimeout(function(){alert(i.solvedMsg)},500),j.solvedMask())})},resetGame:function(){clearInterval(j.clockInterval),a(e).off("click"),a('[data-puzzle="thumbnails"]').off("click"),a('[data-puzzle="levels"]').off("click")},thumbnails:function(){a('[data-puzzle="thumbnails"]').on("click",".item",function c(d){d.preventDefault(),j.resetGame();var f={};"undefined"!=typeof a(this).data("puzzleOptions")&&(f=a(this).data("puzzleOptions").replace(/\'/gi,'"'),f=jQuery.parseJSON(f));var g=a(this).data("puzzleSrc");a(this).siblings().removeClass("active"),a(this).addClass("active"),a('[data-puzzle="thumbnails"]').off("click",".item",c),e.puzzle(b,f,g)})},setLevels:function(){a('[data-puzzle="levels"]').on("click",".levels",function c(d){d.preventDefault(),j.resetGame();var f=a(this).data("level"),g={tileCount:f},h=a('[data-puzzle="thumbnails"]').find(".active").attr("src");a('[data-puzzle="levels"]').off("click",".levels",c),e.puzzle(b,g,h)})}};return j.imageLoader(f.src).then(function(){a(e).parents().map(function(){a(this).is("body")||"static"===a(this).css("position")||a(this).css("position","static")}),j.countdown(),j.setBoard(),j.drawTiles(),j.play(),j.setLevels(),j.thumbnails()}),h}}(jQuery);